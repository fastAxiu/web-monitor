今天聊聊WEB 监控工具中的上报策略，就是什么时候应该上报什么数据，可能存在什么问题，有什么解法。

一般上报的数据类型包含性能数据、API 数据、JS 错误数据、用户行为数据、业务主动埋点数据等。

第一种，随时上报。有一条上报一条，这种上报方式的问题就在于在浏览器的控制台中会看到大量的上报请求，arms 就是这么做的，不过它的上报是通过图片请求的方式来做，相对来说会轻量一点。图片请求的优势，一是在于不会存在跨域问题，二是使用1*1的gif 动图，既能做到体积最小化，又不会阻塞页面加载。另外，这种上报方式基本不会丢失数据。使用gif 上报详细原因参考：https://www.likecs.com/show-205001568.html

虽然说是有一条上报一条，但是实际上特定场景下也会做聚合统计。比如说现代前端框架基本都使用了双向绑定，循环检查会导致很多场景下JS 错误爆炸式出现，这种情况下再逐条上报显然不太合适，而且都是同类JS 错误，这种情况下就会进行聚合。计算同一个JS 错误短时间内爆发了多少次，一起上报。

第二种，节流上报。常见的是攒齐了多少条，或者多长时间没有新数据来再上报（比如2s），这种上报方式的优点是节省资源，上报次数少；缺点是会丢失数据，比如关闭浏览器时还没有上报的那部分数据就会丢失。

那有没有办法在卸载当前页面前把残留的数据上报上去呢？有办法，可以使用navigator.sendBeacon()，监听浏览器的unload 事件，调用sendBeacon 发送数据即可，数据能够正常发出。比如像这样

window.addEventListener('unload', logData, false);

function logData() {
    navigator.sendBeacon("/log", analyticsData);
}

具体内容，可以参考这篇，https://developer.mozilla.org/zh-CN/docs/Web/API/Navigator/sendBeacon，里面提到除了sendBeacon 也可以通过同步的xhr 上报数据，但是会阻塞当前页面的卸载。我试了下，发现同步xhr 似乎不太可行，服务端收不到数据，但是sendBeacon 确实没有问题。上述测试是用一个简单的node 项目尝试的，感兴趣的可以去这里看看：https://github.com/TerminatorSd/nodeMock

第三种，结合一下。一般网站操作中最多、最频繁的监控数据类型是什么呢？是API，一般一次点击或者页面切换会导致多个API 的调用，所以可以针对API 类的数据进行延时上报，其他类型的数据则立即上报。我们的产品目前就是这么做的。至于最后丢掉的那部分API，我们其实也没有用sendBeacon 进行处理，因为在我们看来，那部分丢掉的接口信息其实没有太大影响。

另外，目前很多监控工具都是刻意去丢数据的，比如说随机丢一半用户的访问行为数据、设置采样率随机丢弃，或者不统计加载的详情数据等。就是为了避免数据量太大。数据丢失没有关系，只要数据量达到了，具备了统计学意义就没有问题。像我们的产品，目前每天产生的数据是亿级的，后端越发扛不住了。

![10](./img/10.png)