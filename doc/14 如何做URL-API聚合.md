一个很常见的业务场景，https://xxx/detail/1 和https://xxx/detail/2 实际上是同一个页面，只是url 上携带的id 不同。针对这种场景，在收集上报监控数据的时候，使用方会希望将这两个url 聚合到一起展示，比如展示为https://xxx/detail/ID我们不妨称之为formatedUrl。如何将url 聚合为formatedUrl，有两种思路：
1、在脚本接入侧配置聚合规则（前置）
2、在数据上报后配置聚合规则（后置）

从arms 官方文档中，我们可以看到，它提供了在接入侧进行规则配置的能力，支持字符串、正则、对象、方法和数组等。url 和api 对应的配置项分别为urlHelper 和apiHelper，这种配置方式的好处是，对技术人员比较友好，配置灵活度高，可以完成复杂的转换任务。另外，接入侧配置保证了数据在上报时就已经确定了当前url 的formatedUrl，后端存储时不需要进行额外计算；缺点是配置成本高，每次有了新的url、api，或者已有的内容发生变化时，都要维护这个规则列表。第二个问题就是，未配置规则的历史上报数据无法按照规则更新formatedUrl。

另外一种配置方式，是在数据上报后进行配置。在页面上呈现配置入口，允许页面使用者自定义聚合规则，通过UI 的方式让用户指定，将页面从xxx聚合为xxx。这种配置方式的使用成本低，非技术人员也可以操作，只需要对产品的页面url 或api 有一定的了解即可。除了操作简单外，这种方式理论上还支持对历史数据的更新。不过，在真实业务场景中，一般都不会这么去做。

监控工具后端会面临海量数据的处理，所以一般会采用每日计算数据然后将数据存入中间表的方式，降低查询接口请求时的计算压力。在跨任意时间段查看数据时，除了UV 数据需要重新计算，其他类型数据基本上使用日维度数据做简单的四则运算即可。在前端监控业务的数据呈现中，我们往往会将数据按照url 和api 聚合去查看性能耗时、访问量、影响人数等指标。一旦进行更新，成本高，影响大，会存在系统前后数据不一致的问题。

![014](./img/14.png)